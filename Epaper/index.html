<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>E-Paper HAT - PirateBox</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "E-Paper HAT";
        var mkdocs_page_input_path = "Epaper.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> PirateBox
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Overview/">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Install-Raspberry-Pi/">Install on Raspberry Pi</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Prebuilt-Image/">Prebuilt Image</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Architecture/">Architecture</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Configuration/">Configuration</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Operations/">Operations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">E-Paper HAT</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#hardware-notes">Hardware notes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#install">Install</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#run">Run</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#refresh-behavior">Refresh behavior</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#buttons-optional">Buttons (optional)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#systemd-service-optional">Systemd service (optional)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#cannot-determine-soc-peripheral-base-address">"Cannot determine SOC peripheral base address"</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#debugging">Debugging</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-sources">Data sources</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Development/">Development</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../FAQ/">FAQ</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">PirateBox</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">E-Paper HAT</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/well-it-wasnt-me/PirateBox/edit/master/docs/Epaper.md">Edit on PirateBox v2</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="e-paper-hat">E-Paper HAT<a class="headerlink" href="#e-paper-hat" title="Permanent link">&para;</a></h1>
<p>PirateBox can drive a 2.7 inch e-Paper HAT (264x176, Rev 2.1) to show the PirateBox logo plus local stats (CPU, temp, disk, IP, counts). It also supports four hardware buttons if you wire them and configure GPIO pins.</p>
<h2 id="hardware-notes">Hardware notes<a class="headerlink" href="#hardware-notes" title="Permanent link">&para;</a></h2>
<ul>
<li>Enable SPI on the Pi (<code>raspi-config</code> -&gt; Interface Options -&gt; SPI).</li>
<li>The HAT connects via SPI and is powered from the Pi header.</li>
<li>The display resolution is 264x176.</li>
</ul>
<h2 id="install">Install<a class="headerlink" href="#install" title="Permanent link">&para;</a></h2>
<ol>
<li>Install the e-paper driver library (choose one):</li>
<li><code>rpi_epd2in7</code> (third-party library), or</li>
<li>
<p><code>waveshare_epd</code> from Waveshare examples.</p>
</li>
<li>
<p>(Optional) Use the install script to fetch drivers:</p>
</li>
</ol>
<pre class="highlight"><code class="language-bash">sudo ./scripts/install-epd-driver.sh --driver auto</code></pre>
<ol>
<li>Install the optional Python deps (Pillow + gpiozero). A venv is strongly recommended:</li>
</ol>
<pre class="highlight"><code class="language-bash">python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements-epaper.txt</code></pre>
<p>If GPIO libraries fail to import on Python 3.13, use the system Python (3.11/3.12) or a venv based on it.
On Raspberry Pi 5, <code>RPi.GPIO</code> often fails; install <code>python3-rpi-lgpio</code> (or <code>pip install rpi-lgpio</code>) so the Waveshare driver can import <code>RPi.GPIO</code> via the lgpio backend.</p>
<h2 id="run">Run<a class="headerlink" href="#run" title="Permanent link">&para;</a></h2>
<pre class="highlight"><code class="language-bash">sudo ./scripts/epaper_hat.py --interval 30 --rotate 0</code></pre>
<p>Logo path can be overridden with <code>--logo</code> or <code>PIRATEBOX_EPD_LOGO</code>.
Driver preference can be forced with <code>--driver waveshare_epd</code> or <code>PIRATEBOX_EPD_DRIVER=waveshare_epd</code>.
If the Waveshare library is installed, the script tries <code>epd2in7</code> first, then <code>epd2in7_V2</code>.
Override with <code>PIRATEBOX_EPD_WAVESHARE_MODULE=epd2in7_V2</code> (or <code>epd2in7</code>) if your panel needs it.
You can also set <code>PIRATEBOX_EPD_FONT=/path/to/font.ttf</code> to use a specific TTF font.</p>
<h2 id="refresh-behavior">Refresh behavior<a class="headerlink" href="#refresh-behavior" title="Permanent link">&para;</a></h2>
<p>For smoother updates, the script uses partial refresh when the driver supports it and triggers
full refresh every <code>PIRATEBOX_EPD_FULL_REFRESH_EVERY</code> loops (set to <code>0</code> to disable).
If partial refresh is not available, you can reduce flashing by enabling refresh-on-change.</p>
<p>Refresh-on-change defaults:</p>
<pre class="highlight"><code class="language-bash">PIRATEBOX_EPD_REFRESH_ON_CHANGE=1
PIRATEBOX_EPD_REFRESH_CPU_DELTA=5
PIRATEBOX_EPD_REFRESH_TEMP_DELTA=1
PIRATEBOX_EPD_REFRESH_MEM_DELTA=2
PIRATEBOX_EPD_REFRESH_DISK_DELTA=1
PIRATEBOX_EPD_REFRESH_COUNT_DELTA=1
PIRATEBOX_EPD_REFRESH_IP=1</code></pre>
<p>When enabled, the display only refreshes if those deltas are exceeded or a button forces it.</p>
<h2 id="buttons-optional">Buttons (optional)<a class="headerlink" href="#buttons-optional" title="Permanent link">&para;</a></h2>
<p>Buttons default to the Waveshare HAT pins (BCM 5,6,13,19). Override or disable as needed.</p>
<p>Set button GPIO pins (BCM numbering):</p>
<pre class="highlight"><code class="language-bash">export PIRATEBOX_EPD_BUTTON_PINS=5,6,13,19</code></pre>
<p>Disable buttons entirely:</p>
<pre class="highlight"><code class="language-bash">export PIRATEBOX_EPD_BUTTON_PINS=none</code></pre>
<p>Default actions:</p>
<ul>
<li>Key 1: status page (also refreshes it)</li>
<li>Key 2: network page</li>
<li>Key 3: box contents page</li>
<li>Key 4: sleep/wake display</li>
</ul>
<h2 id="systemd-service-optional">Systemd service (optional)<a class="headerlink" href="#systemd-service-optional" title="Permanent link">&para;</a></h2>
<ol>
<li>Copy the unit file and adjust paths/user:</li>
</ol>
<pre class="highlight"><code class="language-bash">sudo cp ./scripts/piratebox-epaper.service /etc/systemd/system/piratebox-epaper.service
sudo nano /etc/systemd/system/piratebox-epaper.service</code></pre>
<p>The unit expects a venv at <code>/opt/piratebox/.venv</code> by default. Adjust <code>ExecStart=</code> if you live elsewhere.</p>
<ol>
<li>(Optional) Create an environment file for overrides:</li>
</ol>
<pre class="highlight"><code class="language-bash">sudo tee /etc/default/piratebox-epaper &gt;/dev/null &lt;&lt;'EOF'
PIRATEBOX_EPD_INTERVAL=30
PIRATEBOX_EPD_ROTATE=0
PIRATEBOX_EPD_BUTTON_PINS=5,6,13,19
EOF</code></pre>
<ol>
<li>Enable and start:</li>
</ol>
<pre class="highlight"><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable --now piratebox-epaper.service</code></pre>
<ol>
<li>Check status/logs:</li>
</ol>
<pre class="highlight"><code class="language-bash">systemctl status piratebox-epaper.service
journalctl -u piratebox-epaper.service -f</code></pre>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="cannot-determine-soc-peripheral-base-address">"Cannot determine SOC peripheral base address"<a class="headerlink" href="#cannot-determine-soc-peripheral-base-address" title="Permanent link">&para;</a></h3>
<p>This usually means the GPIO library cannot read the Pi's device tree or <code>RPi.GPIO</code> does not support the Pi model:</p>
<ul>
<li>Ensure you're running on the host Pi OS, not inside a container.</li>
<li>Use system Python (3.11/3.12) with <code>python3-rpi-lgpio</code> and <code>python3-spidev</code>.</li>
<li>Confirm <code>/proc/device-tree</code> exists and SPI is enabled (<code>sudo raspi-config</code>).</li>
</ul>
<h3 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h3>
<p>Run with <code>--debug</code> and watch for driver selection logs. If nothing shows up, the driver did not load. That is not a mystery, it is a missing dependency.</p>
<h2 id="data-sources">Data sources<a class="headerlink" href="#data-sources" title="Permanent link">&para;</a></h2>
<ul>
<li>CPU temp: <code>/sys/class/thermal/thermal_zone0/temp</code></li>
<li>CPU usage: <code>/proc/stat</code></li>
<li>Memory: <code>/proc/meminfo</code></li>
<li>Disk: filesystem stats on <code>PIRATEBOX_DATA_DIR</code></li>
<li>PirateBox counts: SQLite at <code>PIRATEBOX_DB_PATH</code></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../Troubleshooting/" class="btn btn-neutral float-left" title="Troubleshooting"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Development/" class="btn btn-neutral float-right" title="Development">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/well-it-wasnt-me/PirateBox" class="fa fa-code-fork" style="color: #fcfcfc"> PirateBox v2</a>
        </span>
    
    
      <span><a href="../Troubleshooting/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Development/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
